<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Crossword Grid Editor v2</title>
    <style>
        body { font-family: sans-serif; text-align: center; }
        #grid { display: grid; margin: 20px auto; gap: 2px; }
        .cell {
            width: 40px; height: 40px; border: 1px solid #aaa;
            background-color: white; position: relative; cursor: pointer;
        }
        .blocked { background-color: black; }
        .number { position: absolute; top: 2px; left: 2px; font-size: 12px; color: black; }
        .solution { position: absolute; bottom: 2px; right: 2px; font-size: 14px; color: blue; opacity: 0.5; }
        button, input { margin: 5px; }
        textarea { width: 90%; height: 150px; margin-top: 10px; }
        .selected { outline: 2px solid red; }
    </style>
</head>
<body>

<h1>Crossword Builder v2</h1>

<div>
    Breite: <input id="width" type="number" value="21" min="1" max="40">
    Höhe: <input id="height" type="number" value="27" min="1" max="40">
    <button type="button" onclick="createGrid()">Grid erstellen</button>
</div>

<div id="grid"></div>

<div>
    Nummer: <input id="clueNumber" type="number" min="1">
    Lösungsbuchstabe: <input id="solutionLetter" type="text" maxlength="1">
    <button onclick="assignData()">Assign</button>
</div>

<div>
    <button onclick="exportData()">Export Data</button>
    <button onclick="clearStorage()">Clear Autosave</button>
</div>

<textarea id="exportArea" placeholder="Exported JSON will appear here"></textarea>
<br>
<textarea id="importArea" placeholder="Paste data here to import"></textarea>
<button type="button" onclick="importData()">Import Data</button>

<script>
let gridData = {};

function createGrid() {
    const grid = document.getElementById('grid');
    const width = parseInt(document.getElementById('width').value);
    const height = parseInt(document.getElementById('height').value);
    grid.style.gridTemplateColumns = `repeat(${width}, 40px)`;
    grid.innerHTML = '';

    // Only reset gridData if we haven't already loaded existing data
    if (!gridData.blocks || !gridData.numbers || !gridData.solutionMap) {
        gridData = { width, height, blocks: [], numbers: {}, solutionMap: {} };
    } else {
        // Just update width/height from UI (needed if user changes size manually)
        gridData.width = width;
        gridData.height = height;
    }

    for (let row = 0; row < height; row++) {
        for (let col = 0; col < width; col++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.row = row;
            cell.dataset.col = col;

            cell.addEventListener('click', () => toggleBlock(cell, row, col));
            cell.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                toggleSelect(cell);
            });

            grid.appendChild(cell);
        }
    }
    saveToStorage();
}


function toggleBlock(cell, row, col) {
    if (cell.classList.contains('blocked')) {
        cell.classList.remove('blocked');
        gridData.blocks = gridData.blocks.filter(pos => !(pos[0] === row && pos[1] === col));
    } else {
        cell.classList.add('blocked');
        gridData.blocks.push([row, col]);
    }
    updateLabels(cell, row, col);
    saveToStorage();
}

function toggleSelect(cell) {
    cell.classList.toggle('selected');
}

function assignData() {
    const clueNumber = parseInt(document.getElementById('clueNumber').value);
    const solutionLetter = document.getElementById('solutionLetter').value.toUpperCase();

    document.querySelectorAll('.cell.selected').forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);

        if (!isNaN(clueNumber)) {
            gridData.numbers[`${row},${col}`] = clueNumber;
        }
        if (solutionLetter) {
            gridData.solutionMap[solutionLetter] = [row, col];
        }
        cell.classList.remove('selected');
        updateLabels(cell, row, col);
    });
    saveToStorage();
}

function updateLabels(cell, row, col) {
    cell.querySelector('.number')?.remove();
    cell.querySelector('.solution')?.remove();

    const num = gridData.numbers[`${row},${col}`];
    if (num !== undefined) {
        const numDiv = document.createElement('div');
        numDiv.className = 'number';
        numDiv.innerText = num;
        cell.appendChild(numDiv);
    }

    for (const [letter, pos] of Object.entries(gridData.solutionMap)) {
        if (pos[0] === row && pos[1] === col) {
            const solDiv = document.createElement('div');
            solDiv.className = 'solution';
            solDiv.innerText = letter;
            cell.appendChild(solDiv);
        }
    }
}

function exportData() {
    document.getElementById('exportArea').value = JSON.stringify(gridData, null, 2);
}

function saveToStorage() {
    localStorage.setItem('crosswordData', JSON.stringify(gridData));
}

function loadFromStorage() {
    const data = localStorage.getItem('crosswordData');
    if (data) {
        gridData = JSON.parse(data);
        loadGridFromData();
    }
}

function clearStorage() {
    localStorage.removeItem('crosswordData');
    alert('Local storage cleared');
}

function importData() {
    const imported = document.getElementById('importArea').value;
    if (imported) {
        gridData = JSON.parse(imported);
        loadGridFromData();
        saveToStorage();
    }
}

function loadGridFromData() {
    document.getElementById('width').value = gridData.width;
    document.getElementById('height').value = gridData.height;

    createGrid(); // recreate the grid with correct size first!

    // now apply blocked cells
    gridData.blocks.forEach(([row, col]) => {
        const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
        if (cell) cell.classList.add('blocked');
    });

    // apply clue numbers
    for (const key in gridData.numbers) {
        const [row, col] = key.split(',').map(Number);
        const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
        if (cell) updateLabels(cell, row, col);
    }

    // apply solution map
    for (const letter in gridData.solutionMap) {
        const [row, col] = gridData.solutionMap[letter];
        const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
        if (cell) updateLabels(cell, row, col);
    }
}


loadFromStorage();
</script>

</body>
</html>
